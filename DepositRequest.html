<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrustDollar Admin Panel – Deposits</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body {background:#0b0b0b;color:#fff;font-family:'Poppins',sans-serif;margin:0;padding:25px;}
  h1 {color:#ffcc00;text-align:center;font-size:28px;margin-bottom:30px;}
  .search-bar {display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
  input {width:60%;padding:12px;border-radius:10px;border:none;outline:none;font-size:15px;}
  .total {background:#111;border:2px solid #00ff6a;color:#00ff6a;padding:10px 20px;border-radius:12px;font-weight:600;text-align:center;font-size:15px;}
  table {width:100%;border-collapse:collapse;background:#161616;border-radius:14px;overflow:hidden;}
  th,td {padding:12px 15px;text-align:left;}
  th {background:#202020;color:#ffcc00;font-weight:600;font-size:15px;}
  td {border-bottom:1px solid #2a2a2a;font-size:14px;}
  tr:hover {background:#1b1b1b;}
  .wallet,.email {color:#4cc9f0;cursor:pointer;font-weight:500;text-decoration:underline;}
  .wallet.hidden,.email.hidden {filter:blur(5px);}
  .wallet:hover,.email:hover {filter:none;}
  .btn {border:none;color:#fff;padding:7px 14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:0.3s;}
  .btn.reject{background:#ff3b3b;} 
  .btn.approve{background:#00d26a;} 
  .btn.referral{background:#ffaa00;}
  .btn:hover{opacity:0.8;}
  td.amount{font-weight:600;color:#00ff88;} td.status{font-weight:600;text-transform:capitalize;}
  .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#00ff6a;color:#000;padding:14px 26px;border-radius:10px;font-weight:600;display:none;font-size:15px;box-shadow:0 0 20px rgba(0,255,100,0.3);animation:fadeInOut 1s ease forwards;z-index:999;}
  @keyframes fadeInOut{0%{opacity:0;}20%{opacity:1;}80%{opacity:1;}100%{opacity:0;}}
</style>
</head>
<body>
  <h1>💰 TrustDollar Deposits</h1>
  <div class="search-bar">
    <input type="text" id="searchBox" placeholder="🔍 Search by name, email, or order ID...">
    <div class="total">Total Approved: $<span id="totalApproved">0.00</span></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Wallet</th>
        <th>Amount</th>
        <th>Order ID</th>
        <th>Status</th>
        <th>Time</th>
        <th>Reject</th>
        <th>Approve</th>
        <th>Referral</th>
      </tr>
    </thead>
    <tbody id="depositTable">
      <tr><td colspan="10" style="text-align:center;opacity:0.7;">Loading data...</td></tr>
    </tbody>
  </table>

  <div id="copyPopup" class="popup">✅ Copied!</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collectionGroup, onSnapshot, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// 🔧 FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain: "btcinvest-c0e25.firebaseapp.com",
  projectId: "btcinvest-c0e25",
  storageBucket: "btcinvest-c0e25.firebasestorage.app",
  messagingSenderId: "204937458487",
  appId: "1:204937458487:web:cc27ece1249999279f60b2",
  measurementId: "G-HG0Q8ZHT6G"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// HTML Elements
const table = document.getElementById("depositTable");
const totalEl = document.getElementById("totalApproved");
const searchBox = document.getElementById("searchBox");
const copyPopup = document.getElementById("copyPopup");

let allData = [];

// 🔁 REALTIME LISTENER
const q = collectionGroup(db, "deposits");
onSnapshot(q, async (snap) => {
  const temp = [];
  let totalApproved = 0;
  const userCache = new Map();

  for (const docSnap of snap.docs) {
    const d = docSnap.data();
    const userPath = docSnap.ref.path.split("/")[1];

    // ⚡ केवल "I Have Paid" वाले दिखाओ
    if (!d.status || d.status.toLowerCase() !== "i have paid") continue;

    if (!userCache.has(userPath)) {
      const userRef = doc(db, "users", userPath);
      const userDoc = await getDoc(userRef);
      userCache.set(userPath, userDoc.exists() ? userDoc.data() : {});
    }

    const userData = userCache.get(userPath);
    temp.push({
      id: docSnap.id,
      userId: userPath,
      name: userData.name || "Unknown",
      email: userData.email || "—",
      address: d.address || "—",
      orderId: d.orderId || "—",
      amount: d.amount || 0,
      status: d.status || "I Have Paid",
      time: d.date ? new Date(d.date.seconds * 1000) : new Date(0)
    });

    if ((d.status || "").toLowerCase() === "approved") {
      totalApproved += parseFloat(d.amount || 0);
    }
  }

  temp.sort((a, b) => b.time - a.time);
  allData = temp;
  totalEl.textContent = totalApproved.toFixed(2);
  renderTable(allData);
});

// 🧾 RENDER TABLE
function renderTable(data) {
  if (!data.length) {
    table.innerHTML = `<tr><td colspan="10" style="text-align:center;opacity:0.7;">No "I Have Paid" deposits 🎉</td></tr>`;
    return;
  }

  table.innerHTML = data.map(item => `
    <tr id="row_${item.id}">
      <td>${item.name}</td>
      <td class="email hidden" onclick="copyText('${item.email}')">${item.email}</td>
      <td class="wallet hidden" onclick="copyText('${item.address}')">${item.address.slice(0, 10)}...</td>
      <td class="amount">$${item.amount}</td>
      <td class="orderid" onclick="copyText('${item.orderId}')">${item.orderId}</td>
      <td class="status" id="status_${item.id}">${item.status}</td>
      <td>${item.time.toLocaleString()}</td>
      <td><button class="btn reject" onclick="handleAction('${item.userId}','${item.id}','Reject',${item.amount})">Reject</button></td>
      <td><button class="btn approve" onclick="handleAction('${item.userId}','${item.id}','Approve',${item.amount})">Approve</button></td>
      <td><button class="btn referral" onclick="handleAction('${item.userId}','${item.id}','Referral',${item.amount})">Referral</button></td>
    </tr>
  `).join("");
}

// ✅ COPY
window.copyText = (text) => {
  navigator.clipboard.writeText(text);
  copyPopup.style.display = "block";
  setTimeout(() => (copyPopup.style.display = "none"), 1000);
};

// ⚙️ MAIN ACTION FUNCTION
window.handleAction = async (userId, depId, type, amount) => {
  try {
    const depRef = doc(db, "users", userId, "deposits", depId);
    const userRef = doc(db, "users", userId);
    const snap = await getDoc(userRef);
    if (!snap.exists()) return alert("User not found!");

    const data = snap.data();
    const wallet = parseFloat(data.walletBalance || 0);
    const lifetime = parseFloat(data.lifetimeDeposit || 0);
    let newWallet = wallet;
    let newLifetime = lifetime;
    let cut = 0;
    let newStatus = type;

    // 🟢 Approve = add to wallet + lifetime
    if (type === "Approve") {
      newWallet = wallet + amount;
      newLifetime = lifetime + amount;
      newStatus = "completed";
    }
    // ❌ Reject = only change status
    else if (type === "Reject") {
      newStatus = "Rejected";
    }
    // 💛 Referral = 94% add, 6% cut
    else if (type === "Referral") {
      cut = (amount * 6) / 100;
      const remaining = amount - cut;
      newWallet = wallet + remaining;
      newStatus = "completed";
      await updateDoc(userRef, {
        totalReferralCut: (parseFloat(data.totalReferralCut || 0) + cut)
      });
    }

    // ✅ Firestore update
    await updateDoc(userRef, {
      walletBalance: newWallet,
      lifetimeDeposit: newLifetime
    });

    await updateDoc(depRef, { status: newStatus });

    // ✅ UI अपडेट तुरंत
    const statusCell = document.getElementById(`status_${depId}`);
    if (statusCell) {
      statusCell.textContent = newStatus;
      statusCell.style.color = (newStatus === "Approved")
        ? "#00ff80"
        : (newStatus === "Rejected")
        ? "#ff4d4d"
        : "#ffaa00";
      statusCell.style.fontWeight = "bold";
    }

    // ✅ Send to Google Sheet
    await fetch("https://script.google.com/macros/s/AKfycbxd0fr6vnR_s7vHwOETJtr7JjyCEKAO4_-oe9Ajz826B8QiQU6m3nyptiFRthOYFanTRQ/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      mode: "no-cors",
      body: JSON.stringify({
        userId: userId,
        name: data.name || "",
        email: data.email || "",
        amount: amount,
        action: type,
        status: newStatus
      })
    });

    alert(`✅ ${type} → ${newStatus} updated successfully!`);
  } catch (err) {
    console.error(err);
    alert("❌ Error: " + err.message);
  }
};

// 🔍 SEARCH
searchBox.addEventListener("input", (e) => {
  const val = e.target.value.toLowerCase();
  const filtered = allData.filter(d =>
    d.name.toLowerCase().includes(val) ||
    d.email.toLowerCase().includes(val) ||
    d.orderId.toLowerCase().includes(val)
  );
  renderTable(filtered);
});
</script>

</body>
</html>
